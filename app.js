function str2buffer (value) {
    let splits = value.split(/([0-9A-Fa-f]{2})/).filter(v => {
        return v.length === 2
    })
    let buf = new DataView(new ArrayBuffer(value.length / 2), 0)
    splits.forEach((item, id) => {
        buf.setUint8(id, parseInt(item, 16))
    })
    // return new DataView(buf)
    return buf
}

function buf2hex (buffer) { // buffer is an ArrayBuffer
    return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('')
}

/**
 * @param {DataView} dv
 * @param {int} [offset]
 * @return {Object|null}
 */
function getBexHeader (dv, offset = 0) {

    if (dv.byteLength < offset + 17) return null

    if (dv.getUint8(offset) === 0x23) {
        let bex = {}
        bex.sequence = dv.getUint32(offset + 1, false)
        bex.type = dv.getUint16(offset + 5, false)
        bex.subtype = dv.getUint16(offset + 7, false)
        bex.request = dv.getUint32(offset + 9, false)
        bex.size = dv.getUint32(offset + 13, false)
        if (bex.size) {
            bex.data = buf2hex(dv.buffer.slice(offset + 17, offset + 17 + bex.size))
        }
        console.log('buffer', bex)
        return bex
    }
    return null
}

const OBIMP_BEX = {
    1: {
        name: "Common",
        1: {name: "CLI_HELLO", type: 'cli'},
        2: {name: "SRV_HELLO", type: 'srv'},
        3: {name: "CLI_LOGIN", type: 'cli'},
        4: {name: "SRV_LOGIN_REPLY", type: 'srv'},
        5: {name: "SRV_BYE", type: 'srv'},
        6: {name: "CLI_SRV_KEEPALIVE_PING", type: 'cli_srv'},
        7: {name: "CLI_SRV_KEEPALIVE_PONG", type: 'cli_srv'},
        8: {name: "CLI_REGISTER", type: 'cli'},
        9: {name: "SRV_REGISTER_REPLY", type: 'srv'}
    },
    2: {
        name: "Contact list",
        1: {name: "CLI_PARAMS", type: 'cli'},
        2: {name: "SRV_PARAMS_REPLY", type: 'srv'},
        3: {name: "CLI_REQUEST", type: 'cli'},
        4: {name: "SRV_REPLY", type: 'srv'},
        5: {name: "CLI_VERIFY", type: 'cli'},
        6: {name: "SRV_VERIFY_REPLY", type: 'srv'},
        7: {name: "CLI_ADD_ITEM", type: 'cli'},
        8: {name: "SRV_ADD_ITEM_REPLY", type: 'srv'},
        9: {name: "CLI_DEL_ITEM", type: 'cli'},
        10: {name: "SRV_DEL_ITEM_REPLY", type: 'srv'},
        11: {name: "CLI_UPD_ITEM", type: 'cli'},
        12: {name: "SRV_UPD_ITEM_REPLY", type: 'srv'},
        13: {name: "CLI_SRV_AUTH_REQUEST", type: 'cli'},
        14: {name: "CLI_SRV_AUTH_REPLY", type: 'cli'},
        15: {name: "CLI_SRV_AUTH_REVOKE", type: 'cli'},
        16: {name: "CLI_REQ_OFFAUTH", type: 'cli'},
        17: {name: "SRV_DONE_OFFAUTH", type: 'srv'},
        18: {name: "CLI_DEL_OFFAUTH", type: 'cli'},
        19: {name: "SRV_ITEM_OPER", type: 'srv'},
        20: {name: "SRV_BEGIN_UPDATE", type: 'srv'},
        21: {name: "SRV_END_UPDATE", type: 'srv'}
    },
    3: {
        name: "Presence",
        1: {name: "CLI_PARAMS", type: 'cli'},
        2: {name: "SRV_PARAMS_REPLY", type: 'srv'},
        3: {name: "CLI_SET_PRES_INFO", type: 'cli'},
        4: {name: "CLI_SET_STATUS", type: 'cli'},
        5: {name: "CLI_ACTIVATE", type: 'cli'},
        6: {name: "SRV_CONTACT_ONLINE", type: 'srv'},
        7: {name: "SRV_CONTACT_OFFLINE", type: 'srv'},
        8: {name: "CLI_REQ_PRES_INFO", type: 'cli'},
        9: {name: "SRV_PRES_INFO", type: 'srv'},
        10: {name: "SRV_MAIL_NOTIF", type: 'srv'},
        11: {name: "CLI_REQ_OWN_MAIL_URL", type: 'cli'},
        12: {name: "SRV_OWN_MAIL_URL", type: 'srv'}
    },
    4: {
        name: "Instant messaging",
        1: {name: "CLI_PARAMS", type: 'cli'},
        2: {name: "SRV_PARAMS_REPLY", type: 'srv'},
        3: {name: "CLI_REQ_OFFLINE", type: 'cli'},
        4: {name: "SRV_DONE_OFFLINE", type: 'srv'},
        5: {name: "CLI_DEL_OFFLINE", type: 'cli'},
        6: {name: "CLI_MESSAGE", type: 'cli'},
        7: {name: "SRV_MESSAGE", type: 'srv'},
        8: {name: "CLI_SRV_MSG_REPORT", type: 'cli'},
        9: {name: "CLI_SRV_NOTIFY", type: 'cli'},
        10: {name: "CLI_SRV_ENCRYPT_KEY_REQ", type: 'cli'},
        11: {name: "CLI_SRV_ENCRYPT_KEY_REPLY", type: 'cli'},
        12: {name: "CLI_MULTIPLE_MSG", type: 'cli'}
    },
    5: {
        name: "Users directory",
        0x0001: {name: "CLI_PARAMS", type: 'cli'},
        0x0002: {name: "SRV_PARAMS_REPLY", type: 'srv'},
        0x0003: {name: "CLI_DETAILS_REQ", type: 'cli'},
        0x0004: {name: "SRV_DETAILS_REQ_REPLY", type: 'srv'},
        0x0005: {name: "CLI_DETAILS_UPD", type: 'cli'},
        0x0006: {name: "SRV_DETAILS_UPD_REPLY", type: 'srv'},
        0x0007: {name: "CLI_SEARCH", type: 'cli'},
        0x0008: {name: "SRV_SEARCH_REPLY", type: 'srv'},
        0x0009: {name: "CLI_SECURE_UPD", type: 'cli'},
        0x000A: {name: "SRV_SECURE_UPD_REPLY", type: 'srv'}
    },
    6: {
        name: "User avatars",
        0x0001: {name: "CLI_PARAMS", type: 'cli'},
        0x0002: {name: "SRV_PARAMS_REPLY", type: 'srv'},
        0x0003: {name: "CLI_AVATAR_REQ", type: 'cli'},
        0x0004: {name: "SRV_AVATAR_REPLY", type: 'srv'},
        0x0005: {name: "CLI_AVATAR_SET", type: 'cli'},
        0x0006: {name: "SRV_AVATAR_SET_REPLY", type: 'srv'}
    },
    7: {
        name: "File transfer",
        0x0001: {name: "CLI_PARAMS", type: 'cli'},
        0x0002: {name: "SRV_PARAMS_REPLY", type: 'srv'},
        0x0003: {name: "CLI_SRV_SEND_FILE_REQUEST", type: 'cli'},
        0x0004: {name: "CLI_SRV_SEND_FILE_REPLY", type: 'cli'},
        0x0005: {name: "CLI_SRV_CONTROL", type: 'cli'},
        0x0101: {name: "DIR_PROX_ERROR", type: 'dir'},
        0x0102: {name: "DIR_PROX_HELLO", type: 'dir'},
        0x0103: {name: "DIR_PROX_FILE", type: 'dir'},
        0x0104: {name: "DIR_PROX_FILE_REPLY", type: 'dir'},
        0x0105: {name: "DIR_PROX_FILE_DATA", type: 'dir'}
    },
    8: {
        name: "Transports",
        0x0001: {name: "CLI_PARAMS", type: 'cli'},
        0x0002: {name: "SRV_PARAMS_REPLY", type: 'srv'},
        0x0003: {name: "SRV_ITEM_READY", type: 'srv'},
        0x0004: {name: "CLI_SETTINGS", type: 'cli'},
        0x0005: {name: "SRV_SETTINGS_REPLY", type: 'srv'},
        0x0006: {name: "CLI_MANAGE", type: 'cli'},
        0x0007: {name: "SRV_TRANSPORT_INFO", type: 'srv'},
        0x0008: {name: "SRV_SHOW_NOTIF", type: 'srv'},
        0x0009: {name: "SRV_OWN_AVATAR_HASH", type: 'srv'}
    },
    9: {
        name: "Admin Command",
        1: {name: "CLI_PARAMS", type: 'cli'},
        2: {name: "SRV_PARAMS_REPLY", type: 'srv'}
    }
}


let app = new Vue({
    el: '#app',
    data: {
        hexPackages: [
            '2300000001000100040000000000000070000000020000001c000200150003000c0004000c0005000a0006000600070005000800090000000300000004000200000000000800000038000200010001000300030001000100050004000100010002000500010001000100060001000100010007000100010001000800010001000223000000020002000100000000000000002300000002000200020000000000000099000000010000000400000fa0000000020000000400000200000000030000000400001f400000000400000004000000ff0000000500000004000002000000000600000004000008000000000700000004000000030000000800000004000004000000000900000004000000000000000a00000001000000000b00000004000003e80000000c00000004000000ff0000000d00000004000004002300000003000400010000000000000000230000000400070001000000000000000023000000050008000100000000000000002300000006000200030000000000000000230000000300040002000000000000002d0000000100000004000000ff000000020000000400008000000000030000000400000001000000040000000101230000000700040003000000000000000023000000040007000200000000000000420000000100000004000000ff0000000200000004000004000000000300000004000000ff000000040000000400007fff00000005000000010100000006000000010023000000050008000200000000000001b3000000010000000400000005000000020000019f0000000111345c706c5a4f248cca94e1c80716e800000187000100034943510002000349435100030004494351230004000d6c6f67696e2e6963712e636f6d00050004000014460006002800000001000000020000000700000008000000090000000a00000003000000040000000500000006000700010100080001230009000101000a000101000b000101000c000101000d000101000e000101000f0001010010000101001100010100120001010013000101001400010100150001010016000101001700010100180001010019000101001a000101001b000101001c000101001d000100100100010110020001011003000101100400010110050001011006000101100700010110080001011009000101100a000101100b000101100c000101100d000101100e000101100f000101101000010010110001001012000101101300010110140001011015000101101600010110170001011018000101200100010120020001012003000101200400010120050001012006000101200700010120080001012009000101200a000101200b000101200c000100200d00010123000000060002000400000000000001ba00000001000001b20000000b00010000000100000000000000120001000ed093d180d183d0bfd0bfd0b0203100010000000400000000000000120001000ed093d180d183d0bfd0bfd0b02032000200000003000000010000001b000200057573657231000300057573657231000400010000060000000200000005000000010000001b00020005757365723200030005757365723200040001000006000000020000000600000004000000300002000575736572330003001ad09fd0bed0bbd18cd0b7d0bed0b2d0b0d182d0b5d0bbd18c2033000400010000060000000200000007000000010000001b000200057573657234000300057573657234000400010000060000000200000008000000040000002000020008616c657865792d6d00030007416c656b736579000400010000060000000100000009000000010000000f0001000b676f676f6c65762e6e657400010000000a000000090000000b00010007676f676f6c657600010000000b0000000a00000007000100036e657400020000000c0000000b0000002e00020005757365723500030018d09fd0bed0bbd18cd0b7d0bed0b2d0b0d182d0b5d0bbd18c0004000100000600002300000008000300030000000000000079000000010000000a0001000500070008000a00000002000000020001000000030000001042696d6f6964205b416e64726f69645d00000004000000080001000000040005000000050000000200340000000600000023416e64726f696420342e332028392e322e412e322e35295b536f6e79204c543235695d230000000700040007000000000000004e0000000100000008616c657865792d6d00000002000000040000000d000000030000000400000001000000040000000631323334353600000007000000000000000800000008000000005a3a69b42300000008000400040000000000000000230000000900030004000000000000002800000001000000040000000000000002000000000000000300000004000000260000000400000000230000000a000300050000000000000000230000000b00050003000000010000000d0000000100000005757365723523000000090003000900000000000000f600000001000000057573657235000000020000000800000000579f8f3b0000000300000008000000005a3a69b90000000400000008000000005a3a682f000000050000000c3139322e3136382e312e3932000000060000000c3139322e3136382e312e3932000000640000008900000085000000010000000a0001000500070008000a00000002000000020001000000030000001042696d6f6964205b416e64726f69645d00000004000000080001000000040005000000050000000200340000000600000023416e64726f696420342e332028392e322e412e322e35295b536f6e79204c543235695d000000080000000400000003230000000c000400050000000000000000230000000a0003000600000000000000b30000000100000008616c657865792d6d000000020000000400000000000000030000000bd09220d181d0b5d182d0b800000004000000040000001700000005000000013f000000060000000e000100050006000700080009000a00000007000000020001000000080000000642696d6f6964000000090000000800010000003c00010000000a00000008000000005a3a5ef30000000b0000000800000000571b9db00000000f0000000957696e646f77732037230000000b0003000600000000000000bc000000010000000575736572350000000200000004000000000000000400000004000000260000000500000000000000060000000a0001000500070008000a00000007000000020001000000080000001042696d6f6964205b416e64726f69645d000000090000000800010000000400050000000a00000008000000005a3a69b90000000b0000000800000000579f8f3b0000000f00000023416e64726f696420342e332028392e322e412e322e35295b536f6e79204c543235695d230000000c0005000400000001000000f70000000100000002000000000002000000057573657235000000030000000000000019000000010000000004000000000000000500000000000000060000000000000007000000020000000000080000000000000009000000000000000a000000000000000b000000000000000c0000000200000000000d0000000200000000000e00000001000000000f0000000800000000000000000000001000000000000000110000000000000012000000000000001300000000000000140000000000000015000000000000001600000000000000170000000000000018000000000000001a000000000000001b000000000000001c00000000',
            '2300000001000100040000000000000070000000020000001c000200150003000c0004000c0005000a00060006000700050008000900000003000000040002000000000008000000380002000100010003000300010001000500040001000100020005000100010001000600010001000100070001000100010008000100010002230000000200020001000000000000000023000000020002000200000000000000990000000100000004000003e80000000200000004000000ff000000030000000400001f400000000400000004000000ff0000000500000004000000ff0000000600000004000008000000000700000004000000000000000800000004000000000000000900000004000000000000000a00000001000000000b00000004000003e80000000c00000004000000ff0000000d00000004000004002300000003000400010000000000000000230000000400070001000000000000000023000000050008000100000000000000002300000006000200030000000000000000230000000300040002000000000000002d0000000100000004000000ff000000020000000400008000000000030000000400000001000000040000000101230000000700040003000000000000000023000000040007000200000000000000420000000100000004000000ff0000000200000004000004000000000300000004000000ff000000040000000400007fff00000005000000010100000006000000010023000000050008000200000000000000180000000100000004000000050000000200000004000000002300000006000200040000000000000133000000010000012b0000000700010000000100000000000000120001000ed093d180d183d0bfd0bfd0b0203100010000000400000000000000120001000ed093d180d183d0bfd0bfd0b02032000200000003000000010000001b000200057573657231000300057573657231000400010000060000000200000005000000010000001b00020005757365723200030005757365723200040001000006000000020000000600000004000000300002000575736572330003001ad09fd0bed0bbd18cd0b7d0bed0b2d0b0d182d0b5d0bbd18c2033000400010000060000000200000007000000010000001b000200057573657234000300057573657234000400010000060000000200000008000000040000002000020008616c657865792d6d00030007416c656b7365790004000100000600002300000008000300030000000000000079000000010000000a0001000500070008000a00000002000000020001000000030000001042696d6f6964205b416e64726f69645d00000004000000080001000000040005000000050000000200340000000600000023416e64726f696420342e332028392e322e412e322e35295b536f6e79204c543235695d2300000007000400040000000000000000230000000900030004000000000000002800000001000000040000000000000002000000000000000300000004000000260000000400000000230000000a000300050000000000000000230000000b00050003000000010000000d0000000100000005757365723523000000080003000900000000000000f600000001000000057573657235000000020000000800000000579f8f3b0000000300000008000000005a3a78c00000000400000008000000005a3a7892000000050000000c3139322e3136382e312e3932000000060000000c3139322e3136382e312e3932000000640000008900000085000000010000000a0001000500070008000a00000002000000020001000000030000001042696d6f6964205b416e64726f69645d00000004000000080001000000040005000000050000000200340000000600000023416e64726f696420342e332028392e322e412e322e35295b536f6e79204c543235695d000000080000000400000003230000000c00040005000000000000000023000000090003000600000000000000b30000000100000008616c657865792d6d000000020000000400000000000000030000000bd09220d181d0b5d182d0b800000004000000040000001700000005000000013f000000060000000e000100050006000700080009000a00000007000000020001000000080000000642696d6f6964000000090000000800010000003c00010000000a00000008000000005a3a78540000000b0000000800000000571b9db00000000f0000000957696e646f77732037230000000a0005000400000001000000f70000000100000002000000000002000000057573657235000000030000000000000019000000010000000004000000000000000500000000000000060000000000000007000000020000000000080000000000000009000000000000000a000000000000000b000000000000000c0000000200000000000d0000000200000000000e00000001000000000f0000000800000000000000000000001000000000000000110000000000000012000000000000001300000000000000140000000000000015000000000000001600000000000000170000000000000018000000000000001a000000000000001b000000000000001c00000000',
            '2300000001000100040000000000000070000000020000001c000200150003000c0004000c0005000a0006000600070005000800090000000300000004000200000000000800000038000200010001000300030001000100050004000100010002000500010001000100060001000100010007000100010001000800010001000223000000020002000100000000000000002300000003000300010000000000000000230000000400040001000000000000000023000000050005000100000000000000002300000006000600010000000000000000230000000700070001000000000000000023000000080008000100000000000000002300000009000300080000000000000000230000000a00020005000000000000000023000000020002000200000000000000990000000100000004000003e80000000200000004000000ff000000030000000400001f400000000400000004000000ff0000000500000004000000ff0000000600000004000008000000000700000004000000000000000800000004000000000000000900000004000000000000000a00000001000000000b00000004000003e80000000c00000004000000ff0000000d0000000400000400230000000300030002000000000000003c000000010000000400000080000000020000000400000200000000030000000400000080000000040000000400000040000000050000000400000000230000000400040002000000000000002d0000000100000004000000ff00000002000000040000800000000003000000040000000100000004000000010123000000050005000200000000000000360000000100000004000000ff0000000200000004000000ff000000030000000400000800000000040000000100000000050000000101230000000600060002000000000000000c00000001000000040000800023000000070007000200000000000000420000000100000004000000ff0000000200000004000004000000000300000004000000ff000000040000000400007fff0000000500000001010000000600000001002300000008000800020000000000000018000000010000000400000005000000020000000400000000230000000900030009000000000000008e0000000100000008616c657865792d6d000000020000000800000000571b9db00000000300000008000000005a3a9b290000000400000008000000005a3a785400000005000000093132372e302e302e3100000006000000093132372e302e302e310000006400000024000000200000000200000002000100000005000000020013000000080000000400000003230000000a0002000600000000000000180000000100000010da5f96f2ab10711c02f2c8d5bd0aec20230000000b00030003000000000000006d000000010000000e000100050006000700080009000a00000002000000020001000000030000000642696d6f6964000000040000000800010000003c000100000005000000020034000000060000000957696e646f777320370000000800000004000000030000000900000000230000000b0003000900000000000000d30000000100000008616c657865792d6d000000020000000800000000571b9db00000000300000008000000005a3a9b290000000400000008000000005a3a785400000005000000093132372e302e302e3100000006000000093132372e302e302e31000000640000006900000065000000010000000e000100050006000700080009000a00000002000000020001000000030000000642696d6f6964000000040000000800010000003c000100000005000000020034000000060000000957696e646f77732037000000080000000400000003230000000c000300040000000000000034000000010000000400000000000000020000000bd09220d181d0b5d182d0b800000003000000040000001700000004000000013f230000000d000300050000000000000000230000000e000400030000000000000000230000000f0005000300000000000000100000000100000008616c657865792d6d230000000c0003000600000000000000bc000000010000000575736572350000000200000004000000000000000400000004000000260000000500000000000000060000000a0001000500070008000a00000007000000020001000000080000001042696d6f6964205b416e64726f69645d000000090000000800010000000400050000000a00000008000000005a3a9b080000000b0000000800000000579f8f3b0000000f00000023416e64726f696420342e332028392e322e412e322e35295b536f6e79204c543235695d230000000d00040007000000000000004a0000000100000005757365723500000002000000045a3a9b0800000003000000040000000100000004000000054768686a6a00000007000000000000000800000008000000005a3a9b1a230000000e000400040000000000000000230000000f00050004000000000000010b000000010000000200000000000200000008616c657865792d6d000000030000001161646d696e40616c657865792d6d2e727500000019000000010000000004000000000000000500000000000000060000000000000007000000020000000000080000000000000009000000000000000a000000000000000b000000000000000c0000000200000000000d0000000200000000000e00000001000000000f0000000800000000000000000000001000000000000000110000000000000012000000000000001300000000000000140000000000000015000000000000001600000000000000170000000000000018000000000000001a000000000000001b000000000000001c000000002300000010000400050000000000000000'
        ],
        packages: [],
        index: 0
    },
    methods: {
        parse () {
            this.packages.splice(0, this.packages.length)
            let buffer = str2buffer(this.hexPackages[this.index])
            let bex, offset = 0
            while (null !== (bex = getBexHeader(buffer, offset))) {
                offset += bex.size + 17
                this.packages.push(bex)
            }
        },
        getType (id) {
            return OBIMP_BEX[id].name
        },
        getSubtype (bex) {
            return OBIMP_BEX[bex.type][bex.subtype].name
        },
        getPacketType (bex) {
            return OBIMP_BEX[bex.type][bex.subtype].type
        },
        setText (id) {
            this.index = id
        }
    }
})